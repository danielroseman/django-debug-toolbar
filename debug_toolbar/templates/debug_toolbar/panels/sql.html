{% load i18n %}
{% if most_executed %}
    <p><a href="#most-executed">Jump to most executed queries</a></p>
{% endif %}
<table>
	<thead>
		<tr>
			<th>{% trans "Time" %}&nbsp;(ms)</th>
			<th>{% trans "Action" %}</th>
			<th>Stacktrace</th>
			<th>Query</th>
		</tr>
	</thead>
	<tbody>
		{% for query in queries %}
			<tr class="{% cycle 'djDebugOdd' 'djDebugEven' %}">
				<td>{{ query.duration|floatformat:"2" }}</td>
				<td>
				{% if query.params %}
					{% if query.is_select %}
						<a class="remoteCall" href="/__debug__/sql_select/?sql={{ query.raw_sql|urlencode }}&params={{ query.params|urlencode }}&duration={{ query.duration|floatformat:"2"|urlencode }}&hash={{ query.hash }}">SELECT</a><br>
					{% endif %}
					<a class="remoteCall" href="/__debug__/sql_explain/?sql={{ query.raw_sql|urlencode }}&params={{ query.params|urlencode }}&duration={{ query.duration|floatformat:"2"|urlencode }}&hash={{ query.hash }}">EXPLAIN</a><br>
					{% if is_mysql %}
						<a class="remoteCall" href="/__debug__/sql_profile/?sql={{ query.raw_sql|urlencode }}&params={{ query.params|urlencode }}&duration={{ query.duration|floatformat:"2"|urlencode }}&hash={{ query.hash }}">PROFILE</a><br>
					{% endif %}
				{% endif %}
				</td>
				<td>
					{% if query.stacktrace %}
					<div class="djSQLShowStacktraceDiv"><a class="djSQLShowStacktrace" href="#">Toggle Stacktrace</a></div>
					<div class="djSQLHideStacktraceDiv" style="display:none;">
						<table>
							<tr>
								<th>{% trans "Line" %}</th>
								<th>{% trans "Method" %}</th>
								<th>{% trans "File" %}</th>
							</tr>
							{% for file, line, method in query.stacktrace %}
								<tr>
									<td>{{ line }}</td>
									<td><pre>{{ method|escape }}<pre></td>
									<td><pre>{{ file|escape }}</pre></td>
								</tr>
							{% endfor %}
						</table>
					</div>
					{% endif %}
				</td>
				<td class="syntax">
					<div class="djDebugSqlWrap">
						<div class="djDebugSql">{{ query.sql|safe }}</div>
						<span class="djDebugLineChart{% if query.is_slow %} djDebugLineChartWarning{% endif %}" style="width:{{ query.width_ratio }}%; left:{{ query.start_offset }}%;"</span>
					</div>
				</td>
			</tr>
		{% endfor %}
	</tbody>
</table>

{% if most_executed %}
<p id="most-executed" style="margin-top:20px"><strong>{{ most_executed|length }} most frequently executed queries:</strong></p>
<table>
    {% for pair in most_executed %}
    <tr class="{% cycle 'djDebugOdd' 'djDebugEven' %}"><td>
        <li>
            {{ pair.0|safe }}<br/>
            executed <strong style="color: red"> {{ pair.1|length }} times</strong>
            <ul style="margin-left: 1em">
            {% for q in pair.1 %}
                <li><strong>{{ q.params }}</strong> {{ q.duration|floatformat:"2" }} s - {{ q.last_stacktrace.0 }} line {{ q.last_stacktrace.1 }} in {{ q.last_stacktrace.2 }}: {{ q.last_stacktrace.3 }}</li>
            {% endfor %}</ul>
        </li>
    </td></tr>
    {% endfor %}
</table>
{% endif %}
